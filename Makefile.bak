CLUSTER_NAME = ink-cluster
APP_JAVA_PORT = 30080
APP_GO_PORT = 30081

# Java app
APP_NAME := $(shell ./gradlew -q properties | grep "^name:" | awk '{print $$2}')
APP_VERSION := $(shell ./gradlew -q properties | grep "^version:" | awk '{print $$2}')
IMAGE_JAVA := $(APP_NAME):$(APP_VERSION)
TAR_JAVA := /tmp/$(APP_NAME).tar

# Go app
IMAGE_GO := spink-go:1.0.1
TAR_GO := /tmp/spink-go.tar

KIND_NODES := $(shell podman ps --format "{{.Names}}" | grep $(CLUSTER_NAME))

.PHONY: help
help:
	@echo ""
	@echo "๐ Proyecto Spink (Java + Go)"
	@echo "๐ท๏ธ  Version Java:  $(APP_VERSION)"
	@echo "๐ฆ Imagen Java:   $(IMAGE_JAVA)"
	@echo "๐ฆ Imagen Go:     $(IMAGE_GO)"
	@echo ""
	@echo "Targets JAVA:"
	@echo "  make build-java      ๐๏ธ  Compila Java con Gradle"
	@echo "  make image-java      ๐ณ Construye imagen Java"
	@echo "  make image-load-java ๐ฅ Carga imagen Java en kind"
	@echo "  make deploy-java     โธ๏ธ  Despliega Java en K8s"
	@echo "  make wait-java       โณ Espera a que Java estรฉ Ready"
	@echo "  make curl-java       ๐ Prueba Java (puerto $(APP_JAVA_PORT))"
	@echo ""
	@echo "Targets GO:"
	@echo "  make build-go        ๐๏ธ  Compila Go"
	@echo "  make image-go        ๐ณ Construye imagen Go"
	@echo "  make image-load-go   ๐ฅ Carga imagen Go en kind"
	@echo "  make deploy-go       โธ๏ธ  Despliega Go en K8s"
	@echo "  make wait-go         โณ Espera a que Go estรฉ Ready"
	@echo "  make curl-go         ๐ Prueba Go (puerto $(APP_GO_PORT))"
	@echo ""
	@echo "Targets GENERALES:"
	@echo "  make all             ๐ฏ Pipeline completo (Java + Go)"
	@echo "  make clean-k8s       ๐งน Borra recursos K8s"
	@echo "  make reset-cluster   ๐ฅ Recrea el cluster kind"
	@echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# JAVA TARGETS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

.PHONY: build-java
build-java:
	@echo "๐๏ธ  Compilando Java con Gradle..."
	./gradlew clean build

.PHONY: image-java
image-java: build-java
	@echo "๐ณ Construyendo imagen Java: $(IMAGE_JAVA)"
	podman build -t $(IMAGE_JAVA) .

.PHONY: image-load-java
image-load-java:
	@echo "๐ฆ Exportando imagen Java a tar..."
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# GENERAL/COMBO TARGETS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

.PHONY: clean-k8s
clean-k8s:
	@echo "๐งน Eliminando recursos Kubernetes..."
	kubectl delete -f k8s/ --ignore-not-found

.PHONY: deploy
deploy: deploy-java deploy-go
	@echo "โธ๏ธ  Ambas aplicaciones desplegadas"

.PHONY: wait
wait: wait-java wait-go
	@echo "โ Ambas aplicaciones listas"

.PHONY: curl
curl: curl-java curl-go
	@echo "โ Pruebas completadas
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# GO TARGETS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

.PHONY: build-go
build-go:
	@echo "๐๏ธ  Compilando Go..."
	cd go-app && podman build -t $(IMAGE_GO) .

.PHONY: image-go
image-go: build-go
	@echo "๐ณ Imagen Go construida: $(IMAGE_GO)"
 (Java + Go)"
	@$(MAKE) reset-cluster
	@$(MAKE) image-java
	@$(MAKE) image-go
	@$(MAKE) image-load-java
	@$(MAKE) image-load-goo imagen Go a tar..."
	podman save $(IMAGE_GO) -o $(TAR_GO)
	@echo "๐ฅ Cargando imagen Go en kind..."
	kind load image-archive $(TAR_GO) --name $(CLUSTER_NAME)

.PHONY: deploy-go
deploy-go:
	@echo "โธ๏ธ  Aplicando manifests Go..."
	kubectl apply -f k8s/go-deployment.yaml -f k8s/go-service.yaml

.PHONY: wait-go
wait-go:
	@echo "โณ Esperando a que el deployment Go estรฉ listo..."
	kubectl rollout status deployment/spink-go --timeout=90s

.PHONY: curl-go
curl-go:
	@echo ""
	@echo "๐ Probando Go en localhost:$(APP_GO_PORT)..."
	@echo "โก๏ธ  curl http://localhost:$(APP_GO_PORT)/health"
	@curl -i http://localhost:$(APP_GO_PORT)/health || true
	@echo ""

.PHONY: clean-k8ss:"
	kubectl get svc
	@echo ""
	@echo "๐ฅ๏ธ  Nodes:"
	kubectl get nodes -o wide
	@echo ""
	@echo "๐ Escuchando trรกfico en nodo worker (Ctrl+C para parar)"
	@echo "โก๏ธ  Ejecuta en otra terminal:"
	@echo "   curl http://localhost:$(APP_JAVA_PORT)/actuator/health"
	@echo "   curl http://localhost:$(APP_GO_PORT)/health"
	@echo ""
	podman exec -it $(CLUSTER_NAME)-worker tcpdump -ni any port $(APP_JAVA_PORT) or port $(APP_GO
wait:
	@echo "โณ Esperando a que el deployment estรฉ listo..."
	kubectl rollout status deployment/$(APP_NAME) --timeout=90s
 (spink-java)..."
	@POD=$$(kubectl get pod -l app=spink-java -o jsonpath='{.items[0].metadata.name}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	echo "   Pod:  $$POD"; \
	echo "   IP:   $$POD_IP"; \
	echo "   Nodo: $$NODE"; \
	echo ""; \
	echo "๐ง Paso 2: IP del Service:"; \
	SVC_IP=$$(kubectl get svc spink-java -o jsonpath='{.spec.clusterIP}'); \
	echo "   Service ClusterIP: $$SVC_IP"; \
	echo ""; \
	echo "๐ง Paso 3: Lanzando tcpdump en el nodo $$NODE..."; \
	echo "   (solo trรกfico puertos relevantes)"; \
	echo ""; \
	podman exec -d $$NODE sh -c "tcpdump -ni any '(port $(APP_JAVA_PORT) or port $(APP_GO_PORT) or port 8080)' -c 20 > /tmp/net.log"; \
	sleep 1; \
	echo "๐ Paso 4: Ejecutando curl..."; \
	curl -s http://localhost:$(APP_JAVAompleto"
	@$(MAKE) reset-cluster
	@$(MAKE) image
	@$(MAKE) image-load
	@$(MAKE) clean-k8s
	@$(MAKE) deploy
	@$(MAKE) wait
	@$(MAKE) curl
	@echo "โ Todo completado correctamente"

.PHONY: install-net-tools
install-net-tools:
	@echo "๐งฐ Instalando herramientas de red en nodos kind..."
	@for node in $(KIND_NODES); do \
		echo "  ๐ฆ $$node"; \
		podman exec $$node bash -c "apt update && apt install -y tcpdump iproute2 iputils-ping net-tools" >/dev/null; \
	done
	@echo "โ Herramientas instaladas en todos los nodos"

.PHONY: test-net-1
test-net-1: 
	@echo ""
	@echo "๐งช LABORATORIO DE RED (NodePort tracing real)"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo ""
	@echo "๐ฆ Pods e IPs:"
	kubectl get pods -o wide
	@echo ""
	@echo "๐ Service:"
	kubectl get svc spink
	@echo ""
	@echo "๐ฅ๏ธ  Nodes:"
	kubectl get nodes -o wide
	@echo ""
	@echo "๐ Escuchando trรกfico en nodo worker (Ctrl+C para parar)"
	@echo "โก๏ธ  Ejecuta en otra terminal:"
	@echo "   curl http://localhost:$(APP_PORT)/actuator/health"
	@echo ""
	podman exec -it $(CLUSTER_NAME)-worker tcpdump -ni any port $(APP_PORT) or port 8080

.PHONY: test-net-2
test-net-2:
	@echo ""
	@echo "๐ง Paso 1: Localizando Pod real..."
	@POD=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].metadata.name}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	echo "   Pod:  $$POD"; \
	echo "   IP:   $$POD_IP"; \
	echo "   Nodo: $$NODE"; \
	echo ""; \
	echo "๐ง Paso 2: IP del Service:"; \
	SVC_IP=$$(kubectl get svc spink -o jsonpath='{.spec.clusterIP}'); \
	echo "   Service ClusterIP: $$SVC_IP"; \
	echo ""; \
	echo "๐ง Paso 3: Lanzando tcpdump en el nodo $$NODE..."; \
	echo "   (solo trรกfico 30080 y 8080)"; \
	echo ""; \
	podman exec -d $$NODE sh -c "tcpdump -ni any '(port 30080 or port 8080)' -c 20 > /tmp/net.log"; \
	sleep 1; \
	echo "๐ Paso 4: Ejecutando curl..."; \
	curl -s http://localhost:$(APP_PORT)/actuator/health > /dev/null; \
	sleep 2; \
	echo ""; \
	echo "๐ฆ Captura REAL del trรกfico:"; \
	echo "------------------------------------------"; \
	podman exec $$NODE cat /tmp/net.log; \
	echo "------------------------------------------"; \
	echo ""; \
	echo "โ Fin del test de red"

.PHONY: show-ips
show-ips:
	@echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "๐ INFORMACIรN DE IPs Y PUERTOS DE TU CLUSTER"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo ""
	@echo "๐ CAPA HOST (MacBook):"
	@echo "   localhost = 127.0.0.1"
	@echo "   Port: $(APP_PORT) (mapeado por Podman)"
	@echo ""
	@echo "๐ CAPA PODMAN (Container Runtime):"
	@echo "   Control-Plane container IP: 172.18.0.2"
	@echo "   Port mapping: 127.0.0.1:$(APP_PORT) โ 172.18.0.2:$(APP_PORT)"
	@echo ""
	@echo "๐ CAPA KUBERNETES (Node IPs - Podman Network):"
	@kubectl get nodes -o wide | awk 'NR==1 {print "   " $$0} NR>1 {print "   " $$1 " โ " $$6}'
	@echo ""
	@echo "๐ SERVICE (Kubernetes Virtual):"
	@kubectl get svc spink -o wide | awk 'NR==2 {print "   Name: " $$1; print "   ClusterIP: " $$3; print "   Port: " $$5; print "   Selector: " $$8 " " $$9}'
	@echo ""
	@echo "๐ PODs (Con IPs reales asignadas):"
	@kubectl get pods -o wide -l app=spink | awk 'NR==1 {print "   " $$0} NR>1 {print "   " $$1 " โ IP: " $$6 " on node " $$7}'
	@echo ""
	@echo "๐ ENDPOINTS (destinos reales del Service):"
	@ENDPOINTS=$$(kubectl get endpoints spink -o jsonpath='{.subsets[0].addresses[*].ip}' | tr ' ' ','); \
	PORTS=$$(kubectl get endpoints spink -o jsonpath='{.subsets[0].ports[0].port}'); \
	echo "   Service endpoints: $$ENDPOINTS:$$PORTS" || echo "   No endpoints found"
	@echo ""
	@echo "๐ IPTABLES RULES (en control-plane):"
	@echo "   Para ver las reglas reales ejecuta:"
	@echo "   podman exec ink-cluster-control-plane iptables -t nat -L -n | grep KUBE"
	@echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo ""
	@echo "๐ FLUJO DEL TRรFICO:"
	@echo ""
	@echo "1๏ธโฃ  curl http://localhost:$(APP_PORT)/actuator/health"
	@echo "   โโ Destino: 127.0.0.1:$(APP_PORT)"
	@echo ""
	@echo "2๏ธโฃ  Podman Port Forward"
	@echo "   โโ Redirige a: 172.18.0.2:$(APP_PORT)"
	@echo ""
	@echo "3๏ธโฃ  Nodo Control-Plane iptables"
	@echo "   โโ Intercepta puerto $(APP_PORT)"
	@echo "   โโ Traduce a: Service ClusterIP 10.96.120.15:80"
	@echo ""
	@echo "4๏ธโฃ  kube-proxy resoluciรณn de endpoints"
	@POD_IP=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].status.podIP}'); \
	echo "   โโ Selecciona Pod: $$POD_IP:8080"
	@echo ""
	@echo "5๏ธโฃ  Pod recibe trรกfico"
	@echo "   โโ Container escucha en 0.0.0.0:8080"
	@echo "   โโ Spring Boot responde con Health: UP"
	@echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo ""

.PHONY: trace
trace:
	@echo ""
	@echo "๐ง Descubriendo pod y nodo..."
	@POD=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].metadata.name}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	echo "๐ฆ Pod:   $$POD"; \
	echo "๐ฅ  Nodo:  $$NODE"; \
	echo "๐ IP Pod: $$POD_IP"; \
	echo ""; \
	echo "๐ต๏ธ Capturando trรกfico HTTP real durante 6 segundos..."; \
	echo "------------------------------------------------------------"; \
	podman exec -it $$NODE sh -c "timeout 6 tcpdump -n -i any -A '(port 30080 or port 8080) and tcp' 2>/dev/null \
	| grep -E 'IP |GET /|HTTP/1.1'"; \
	echo "------------------------------------------------------------"; \
	echo ""; \
	echo "๐ Ejecutando curl real..."; \
	curl -s http://localhost:30080/actuator/health; \
	echo ""; \
	echo ""; \
	echo "โ Fin del trace"


.PHONY: trace-deep
trace-deep:
	@echo ""
	@echo "๐ง Descubriendo pod y nodo..."
	@POD=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].metadata.name}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	echo "๐ฆ Pod:   $$POD"; \
	echo "๐ฅ  Nodo:  $$NODE"; \
	echo "๐ IP Pod: $$POD_IP"; \
	echo ""; \
	echo "๐ง Captura TCP detallada durante 6 segundos..."; \
	echo "------------------------------------------------------------"; \
	podman exec -it $$NODE sh -c "timeout 6 tcpdump -n -tttt -i any '(port 30080 or port 8080) and tcp' 2>/dev/null"; \
	echo "------------------------------------------------------------"; \
	echo ""; \
	echo "๐ Ejecutando curl real..."; \
	curl -s http://localhost:30080/actuator/health; \
	echo ""; \
	echo ""; \
	echo "โ Fin del trace-deep"


.PHONY: trace-visual
trace-visual:
	@echo ""
	@echo "๐ง Descubriendo infraestructura real..."
	@SVC=spink; \
	POD=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].metadata.name}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	NODEPORT=$$(kubectl get svc $$SVC -o jsonpath='{.spec.ports[0].nodePort}'); \
	echo ""; \
	echo "๐ฆ Pod:     $$POD"; \
	echo "๐ฅ  Nodo:    $$NODE"; \
	echo "๐ IP Pod:   $$POD_IP"; \
	echo ""; \
	echo "๐ Ruta REAL que sigue tu curl:"; \
	echo ""; \
	echo " [Tu Mac]"; \
	echo "   localhost:PUERTO_ALEATORIO"; \
	echo "        โ"; \
	echo "        โผ"; \
	echo " [Nodo kind]"; \
	echo "   :$$NODEPORT"; \
	echo "        โ  kube-proxy + iptables (DNAT)"; \
	echo "        โผ"; \
	echo " [Pod spink]"; \
	echo "   $$POD_IP:8080"; \
	echo ""; \
	echo "๐ต๏ธ Capturando trรกfico REAL (simplificado, solo IPs) durante 6 segundos..."; \
	echo "------------------------------------------------------------"; \
	podman exec -it $$NODE sh -c "\
	  timeout 6 tcpdump -n -tt -q -i any '(host $$POD_IP and port 8080) or port $$NODEPORT' \
	"; \
	echo "------------------------------------------------------------"; \
	echo ""; \
	echo "๐ Ejecutando curl real:"; \
	curl -s http://localhost:$$NODEPORT/actuator/health; \
	echo ""; \
	echo ""; \
	echo "โ Fin del trace-visual"



.PHONY: trace-iptables
trace-iptables:
	@echo ""
	@echo "๐ง Descubriendo servicio spink..."
	@SVC=spink; \
	POD=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].metadata.name}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	CLUSTER_IP=$$(kubectl get svc $$SVC -o jsonpath='{.spec.clusterIP}'); \
	NODEPORT=$$(kubectl get svc $$SVC -o jsonpath='{.spec.ports[0].nodePort}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	echo "๐ฆ Pod:        $$POD"; \
	echo "๐ IP Pod:     $$POD_IP"; \
	echo "๐ ClusterIP:  $$CLUSTER_IP"; \
	echo "๐ช NodePort:   $$NODEPORT"; \
	echo "๐ฅ Nodo:       $$NODE"; \
	echo ""; \
	echo "๐ Reglas iptables relevantes (nat table)"; \
	echo "------------------------------------------------------------"; \
	podman exec -it $$NODE sh -c "\
	  iptables -t nat -S | grep $$NODEPORT; \
	  echo ''; \
	  iptables -t nat -S | grep $$CLUSTER_IP; \
	  echo ''; \
	  iptables -t nat -S | grep $$POD_IP \
	"; \
	echo "------------------------------------------------------------"; \
	echo ""; \
	echo "๐ง Lectura humana:"; \
	echo "curl localhost:$$NODEPORT"; \
	echo "  โ KUBE-NODEPORTS"; \
	echo "  โ KUBE-EXT-*"; \
	echo "  โ KUBE-SVC-*"; \
	echo "  โ KUBE-SEP-*"; \
	echo "  โ DNAT $$POD_IP:8080"; \
	echo ""; \
	echo "โ Fin trace-iptables"


.PHONY: trace-explain
trace-explain:
	@echo ""
	@echo "๐ง Analizando enrutamiento real de Kubernetes..."
	@SVC=spink; \
	POD=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].metadata.name}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	CLUSTER_IP=$$(kubectl get svc $$SVC -o jsonpath='{.spec.clusterIP}'); \
	NODEPORT=$$(kubectl get svc $$SVC -o jsonpath='{.spec.ports[0].nodePort}'); \
	echo ""; \
	echo "๐ฆ Pod:        $$POD"; \
	echo "๐ IP Pod:     $$POD_IP"; \
	echo "๐ ClusterIP:  $$CLUSTER_IP"; \
	echo "๐ช NodePort:   $$NODEPORT"; \
	echo "๐ฅ Nodo:       $$NODE"; \
	echo ""; \
	echo "๐ Buscando reglas reales en iptables (nat)..."; \
	echo "------------------------------------------------------------"; \
	podman exec -it $$NODE sh -c "\
	  iptables -t nat -S | grep $$NODEPORT || true; \
	  iptables -t nat -S | grep $$CLUSTER_IP || true; \
	  iptables -t nat -S | grep $$POD_IP || true \
	"; \
	echo "------------------------------------------------------------"; \
	echo ""; \
	echo "๐ง Traducciรณn humana:"; \
	echo ""; \
	echo "1๏ธโฃ Tu curl entra por localhost:$$NODEPORT"; \
	echo "2๏ธโฃ kube-proxy detecta trรกfico NodePort ($$NODEPORT)"; \
	echo "3๏ธโฃ iptables lo redirige a Service ($$CLUSTER_IP)"; \
	echo "4๏ธโฃ iptables aplica DNAT hacia el pod"; \
	echo "5๏ธโฃ Destino final real: $$POD_IP:8080"; \
	echo ""; \
	echo "๐ En castellano claro:"; \
	echo \"   'Todo lo que entra por el puerto $$NODEPORT acaba en $$POD_IP:8080'\"; \
	echo ""; \
	echo "โ Fin del trace-explain"

.PHONY: trace-animate
trace-animate:
	@echo ""
	@echo "๐ฌ TRACE ANIMATE โ siguiendo un paquete REAL paso a paso"
	@echo ""

	@SVC=spink; \
	POD=$$(kubectl get pod -l app=spink -o jsonpath='{.items[0].metadata.name}'); \
	POD_IP=$$(kubectl get pod $$POD -o jsonpath='{.status.podIP}'); \
	NODE=$$(kubectl get pod $$POD -o jsonpath='{.spec.nodeName}'); \
	NODEPORT=$$(kubectl get svc $$SVC -o jsonpath='{.spec.ports[0].nodePort}'); \
	CLUSTER_IP=$$(kubectl get svc $$SVC -o jsonpath='{.spec.clusterIP}'); \
	echo "๐ฆ Pod:       $$POD"; \
	echo "๐ IP Pod:    $$POD_IP"; \
	echo "๐ฅ Nodo:      $$NODE"; \
	echo "๐ช NodePort:  $$NODEPORT"; \
	echo "๐ ClusterIP: $$CLUSTER_IP"; \
	echo ""; \
	echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"; \
	echo "1๏ธโฃ curl desde tu Mac"; \
	echo "   curl http://localhost:$$NODEPORT"; \
	echo "   โณ destino inicial: Nodo:$$NODEPORT"; \
	echo ""; \
	echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"; \
	echo "2๏ธโฃ kube-proxy instala reglas iptables"; \
	echo "   Buscando reglas relacionadas..."; \
	echo ""; \
	podman exec -it $$NODE sh -c "\
	  iptables -t nat -S | grep $$NODEPORT || true; \
	  iptables -t nat -S | grep $$CLUSTER_IP || true; \
	  iptables -t nat -S | grep $$POD_IP || true \
	"; \
	echo ""; \
	echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"; \
	echo "3๏ธโฃ Traducciรณn humana de esas reglas:"; \
	echo ""; \
	echo "   โ trรกfico que entra por :$$NODEPORT"; \
	echo "   โ se redirige al Service $$CLUSTER_IP:80"; \
	echo "   โ luego DNAT al Pod $$POD_IP:8080"; \
	echo ""; \
	echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"; \
	echo "4๏ธโฃ Captura real del trรกfico (solo IPs claras)"; \
	echo "   Durante 6 segundos mientras hacemos curl"; \
	echo ""; \
	echo "   (mira IP_origen > IP_destino)"; \
	echo ""; \
	podman exec -it $$NODE sh -c "\
	  timeout 6 tcpdump -n -q -tt -i any '(host $$POD_IP and port 8080) or port $$NODEPORT' \
	" & \
	sleep 1; \
	echo ""; \
	echo "   โ Ejecutando curl ahora"; \
	curl -s http://localhost:$$NODEPORT/actuator/health > /dev/null; \
	wait; \
	echo ""; \
	echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"; \
	echo "5๏ธโฃ Resumen final (como pelรญcula mental):"; \
	echo ""; \
	echo "   [Tu Mac]"; \
	echo "       localhost:PUERTO_ALEATORIO"; \
	echo "              โ"; \
	echo "              โผ"; \
	echo "   [Nodo kind $$NODE]"; \
	echo "       :$$NODEPORT"; \
	echo "              โ kube-proxy + iptables"; \
	echo "              โผ"; \
	echo "   [Service $$SVC]"; \
	echo "       $$CLUSTER_IP:80"; \
	echo "              โ"; \
	echo "              โผ"; \
	echo "   [Pod $$POD]"; \
	echo "       $$POD_IP:8080"; \
	echo ""; \
	echo "โ Fin del trace-animate"
